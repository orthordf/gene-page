extends ../layout


block content
  //  case insensitive version of string.includesCI
  - String.prototype.includesCI = function (str) { return this.toLowerCase().indexOf(str.toLowerCase()) !== -1; }
  div.container
    div.title-header
      a(href=pathFromRoot('/genes'))
        =`${currentTaxonomy ? taxonomyDisplayName(currentTaxonomy) : 'Human'}`
      div.search-area
        span
          include includes/search-area.pug
    br
    - let includingNotAuthorized = false
    if query
      span.text-bold=`"${query}"`
      =" hit "
      span.text-bold=pagination.totalCount
      =` genes (hit strings shown in `
      span.text-bold="bold"
      =")"
    else
      span.text-bold=pagination.totalCount
      =` genes exist in the database`
    if pagination.totalPages > 1
      div.text-center
        ul.pagination
          - let page = pagination.page
          if page > 1
            li
              a.pagination-link(href='#', data-page=page - 1) <
          else
            li(class='disabled')
              a(href='#') <
          - const pageRange = 5;
          if page > pageRange
            li
              a.pagination-link(href='#', data-page=1) 1
            li.disabled
              a(href='#') ...
          - let i = Math.max(0, page - pageRange)
          - let maxPage = Math.min(pagination.totalPages, page + pageRange - 1)
          while i < maxPage
            - let j = i + 1
            if j === page
              li.active
                a=j
            else
              li
                a.pagination-link(href='#', data-page=j)=j
            - ++i
          if page < pagination.totalPages - pageRange
            li.disabled
              a(href='#') ...
            li
              a.pagination-link(href='#', data-page=pagination.totalPages)=pagination.totalPages
          if page < pagination.totalPages
            li
              a.pagination-link(href='#', data-page=page + 1) >
          else
            li.disabled
              a(href='#') >
          .align-center
            =`ã€€Showing ${limit} genes per page`

    if geneInfoList.length === 0
      h3='No gene found'
    else
      - queryContent = query ? query.replace('^', '') : ''
      table(border=1)
        thead(align='left')
          tr
            th='GeneID'
            th="Type of gene"
            th="Symbol"
            th="Synonyms"
            th="Description"
            th="Other designations"
            th="Location"
            th="Feature"
            th="Link"
            th="Modification date"
        tbody
          each geneInfo in geneInfoList
            tr
              td
                a(href=pathFromRoot(`/genes/${geneInfo.id}`))
                  if searchMode === 'free-text' && query && geneInfo.id.toString().includesCI(queryContent)
                    span.text-bold=geneInfo.id
                  else
                    =geneInfo.id
              td.small-cell=geneInfo.type_of_gene
              td
                - let symbol = geneInfo.symbol
                - let symbolAuthorized = geneInfo.symbol_from_nomenclature_authority
                if symbol !== symbolAuthorized && symbolAuthorized && symbolAuthorized !== '-'
                  if searchMode !== 'synonym' && query && symbolAuthorized && symbolAuthorized.includesCI(queryContent)
                    span.text-bold=symbolAuthorized
                  else
                    =symbolAuthorized
                  br
                if searchMode !== 'synonym' && query && symbol && symbol.includesCI(queryContent)
                  span.text-bold=symbol
                else
                  =symbol
                if symbol !== symbolAuthorized
                  - includingNotAuthorized = true
                  sup
                    span(style='font-size: 0.6em')
                      =' (*)'
              td.small-cell
                if geneInfo.synonyms
                  each synonym in geneInfo.synonyms.split('|')
                    if searchMode !== 'symbol' && query && synonym.includesCI(queryContent)
                      span.text-bold=synonym
                    else
                      =synonym
                    br
              td
                - let description = geneInfo.description
                - let descriptionAuthorized = geneInfo.full_name_from_nomenclature_authority
                if description !== descriptionAuthorized && descriptionAuthorized && descriptionAuthorized !== '-'
                  if searchMode !== 'free-text' && query && descriptionAuthorized && descriptionAuthorized.includesCI(queryContent)
                    span.text-bold=descriptionAuthorized
                  else
                    =descriptionAuthorized
                  br
                if searchMode !== 'synonym' && query && description && description.includesCI(queryContent)
                  span.text-bold=description
                else
                  =description
                if description !== descriptionAuthorized
                  - includingNotAuthorized = true
                  sup
                    span(style='font-size: 0.6em')
                      =' (*)'
              td.small-cell
                if geneInfo.other_designations
                  each line in geneInfo.other_designations.split('|')
                    if searchMode === 'free-text' && query && line.includesCI(queryContent)
                      span.text-bold=line
                    else
                      =line
                    br
              td
                if searchMode === 'free-text' && query && geneInfo.map_location.includesCI(queryContent)
                  span.text-bold=geneInfo.map_location
                else
                  =geneInfo.map_location
              td
                if geneInfo.feature_type
                  each line in geneInfo.feature_type.split('|')
                    if searchMode === 'free-text' && query && line.includesCI(queryContent)
                      span.text-bold=line
                    else
                      =line
              td.small-cell
                a(href=`https://www.ncbi.nlm.nih.gov/gene/${geneInfo.id}` target='_blank' rel='noopener noreferrer')
                  ='NCBI'
              td
                if searchMode === 'free-text' && query && geneInfo.modification_date.includesCI(queryContent)
                  span.text-bold=geneInfo.modification_date
                else
                  =geneInfo.modification_date
      if includingNotAuthorized
        div.text-center
          span(style='font-size: 0.6em')
            ='(*) symbol/description in NCBI'

block script
  script.


    document.querySelectorAll('.pagination-link').forEach(link => link.addEventListener('click', onPaginationLinkClick));

    function onPaginationLinkClick(e) {
      let link = e.target;
      let pageNum = link.dataset.page;
      let url = new URL(window.location.href)
      url.searchParams.set('page', pageNum);
      window.location.href = url;
    }